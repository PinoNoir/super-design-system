import { Canvas, Meta } from '@storybook/addon-docs/blocks';
import * as FileUploaderStories from './FileUploader.stories';

<Meta of={FileUploaderStories} />

# File Uploader

The `FileUploader` component allows users to upload files to the system from their local device. As of v2.0, it operates as a self-contained component with no external context dependencies required.

## Features

- **Self-Contained Component**: No context provider required - works independently
- **Flexible Upload API**: Promise-based upload handlers with configurable adapters
- **Built-in Upload Adapters**: REST API, FormData, chunked uploads, and S3 support
- **Drag and Drop**: Users can drag files directly into the component area or use a traditional file selection dialog
- **Multiple File Support**: Allows uploading multiple files simultaneously
- **File Type Validation**: Ensures only specified file types are uploaded
- **Upload Progress Tracking**: Real-time progress indication with file status management
- **Customizable File Cards**: Renders file information using customizable `FileCard` components
- **Controlled/Uncontrolled Modes**: Works with external state management or self-contained

## Usage

### Basic Usage (Self-Contained)

Simple setup with controlled state management:

```jsx
import React, { useState, useCallback } from 'react';
import { FileUploader, FileWithStatus, UploadResult } from 'sds-ui';

const MyComponent = () => {
  const [files, setFiles] = useState<FileWithStatus[]>([]);

  const handleUpload = useCallback(async (file: File): Promise<UploadResult> => {
    // Simulate API upload
    try {
      const formData = new FormData();
      formData.append('file', file);

      const response = await fetch('/api/upload', {
        method: 'POST',
        body: formData,
      });

      const data = await response.json();

      return {
        success: true,
        progress: 100,
        data,
        file,
      };
    } catch (error) {
      return {
        success: false,
        error: error.message,
        file,
      };
    }
  }, []);

  const renderFileCard = useCallback((fileWithStatus: FileWithStatus) => (
    <FileCard
      key={fileWithStatus.file.name}
      file={fileWithStatus}
      metaData="Standalone Upload"
    />
  ), []);

  return (
    <FileUploader
      files={files}
      onFilesChange={setFiles}
      buttonLabel="Select Files"
      helperText="Upload files to your account"
      accept={['.pdf', '.jpg', '.png']}
      multiple={true}
      maxFileSize={10}
      maxFiles={5}
      onUpload={handleUpload}
      renderFileCard={renderFileCard}
    />
  );
};
```

### Using Built-in Upload Adapters

Pre-built adapters for common upload patterns:

#### REST API Upload

```jsx
import { FileUploaderAdapters } from 'sds-ui';

const restUploader = FileUploaderAdapters.createRestUploader({
  baseUrl: 'https://api.example.com',
  endpoint: 'files',
  headers: { Authorization: 'Bearer your-token' },
  formDataKey: 'document',
});

<FileUploader onUpload={restUploader} buttonLabel="Upload to API" />;
```

#### FormData with Additional Fields

```jsx
const formDataUploader = FileUploaderAdapters.createFormDataUploader({
  url: '/api/documents',
  fileKey: 'file',
  additionalFields: {
    userId: '123',
    category: 'documents',
  },
});

<FileUploader onUpload={formDataUploader} />;
```

#### AWS S3 Upload

```jsx
const s3Uploader = FileUploaderAdapters.createS3Uploader({
  region: 'us-east-1',
  bucket: 'my-bucket',
  accessKeyId: 'your-key',
  secretAccessKey: 'your-secret',
});

<FileUploader onUpload={s3Uploader} />;
```

### Custom Upload Configuration

Pass upload configuration at runtime:

```jsx
const handleUpload = async (file: File, config?: UploadConfig) => {
  const uploadUrl = config?.url || '/api/upload';
  // Custom upload logic
};

<FileUploader
  uploadConfig={{
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' }
  }}
  onUpload={handleUpload}
/>
```

## Breaking Changes in v2.0

### Context-Based Usage Removed

The FileUploader v2.0 no longer supports or requires context providers. All context-related components and hooks have been removed:

#### Removed Components and Hooks:

- `FileContextProvider`
- `FileContext`
- `useFileContext`
- `standalone` prop (now default behavior)

#### What to Remove from Your App:

1. **Remove Context Provider Wrapper**:

```jsx
// REMOVE THIS
<FileContextProvider>
  <YourComponent />
</FileContextProvider>
```

2. **Remove Context Hook Usage**:

```jsx
// REMOVE THIS
const { addFile, updateFileProgress, updateFileStatus, showStatusMessage, retryUpload, clearAllFiles } =
  useFileContext();
```

3. **Remove Context-Related Imports**:

```jsx
// REMOVE THESE
import { FileContextProvider, useFileContext } from 'sds-ui';
```

4. **Update Manual File State Management**:
   Replace manual context calls with the new Promise-based approach that handles state automatically.

## Examples

### Basic Usage

<Canvas of={FileUploaderStories.FileUploadExample} />

### Upload Adapter Examples

#### Simple Usage with State Management

<Canvas of={FileUploaderStories.StandaloneMode} />

#### REST API Integration

<Canvas of={FileUploaderStories.RestApiUpload} />

#### FormData Upload

<Canvas of={FileUploaderStories.FormDataUpload} />

## API Reference

### FileUploader Props

#### Core Props

- **buttonLabel** `string` - Label for the file selection button
- **helperText** `string` - Helper text displayed below the uploader
- **accept** `string[]` - Array of accepted file types (e.g., `['.pdf', '.jpg']`)
- **labelDescription** `string` - Additional description for the uploader (e.g., "or Drop Files Here")
- **disabled** `boolean` - Whether the uploader is disabled
- **multiple** `boolean` - Whether multiple file selection is allowed (default: `true`)

#### File Validation

- **maxFileSize** `number` - Maximum file size in MB
- **maxFiles** `number` - Maximum number of files that can be uploaded
- **allowDuplicates** `boolean` - Allow duplicate files (default: `false`)
- **onCustomFilesValidate** `(files: File[]) => boolean` - Custom validation function

#### Upload Configuration

- **uploadConfig** `UploadConfig` - Upload configuration object
- **onUpload** `(file: File, config?: UploadConfig) => Promise<UploadResult> | void` - Upload handler function
- **onUploadSuccess** `(file: File, result: UploadResult) => void` - Success callback
- **onUploadFailure** `(file: File, error: any) => void` - Failure callback

#### State Management

- **files** `FileWithStatus[]` - Controlled files state (optional, uses internal state if not provided)
- **onFilesChange** `(files: FileWithStatus[]) => void` - Files change callback (required when using controlled mode)

#### Rendering & Events

- **renderFileCard** `(file: FileWithStatus) => React.ReactNode` - Custom file card renderer
- **onFileValidationFailure** `(errorType, fileName) => void` - Validation failure callback
- **onSelectedFileAlreadyUploaded** `(fileName) => void` - Duplicate file callback
- **onUploadCompleted** `(files: File[]) => void` - All uploads completed callback
- **onRetryUpload** `(file: File) => void` - Retry upload callback

### Types

#### UploadConfig

```typescript
interface UploadConfig {
  method?: 'POST' | 'PUT' | 'PATCH';
  url?: string;
  headers?: Record<string, string>;
  formDataKey?: string;
  chunkSize?: number;
  concurrent?: boolean;
  timeout?: number;
}
```

#### UploadResult

```typescript
interface UploadResult {
  success: boolean;
  progress?: number;
  error?: string;
  data?: any;
  file?: File;
}
```

### Upload Adapters

Pre-built upload adapters available via `FileUploaderAdapters`:

- **createRestUploader(config)** - Generic REST API uploads
- **createFormDataUploader(config)** - FormData with additional fields
- **createChunkedUploader(config)** - Large file chunked uploads
- **createS3Uploader(config)** - AWS S3 presigned URL uploads

<hr />

# FileCard

> Displays individual file information including status, progress, and actions like edit, download, and delete.
> Used internally by the `FileUploader` component to display individual file information.
> Can be used independently to display file information in a list or grid format.

<Canvas of={FileUploaderStories.FileCardExamples} />

### FileCard Props:

fileWithStatus: (object) Object containing file info and status.
onRetryUpload: (function) Callback for retrying upload.
metaData: (string) Additional metadata for the file.

## Migration Guide

### Migrating from Context-Based to Standalone Mode

**Before (Legacy Context-Based):**

```jsx
import { FileContextProvider, useFileContext, FileUploader } from 'sds-ui';

const MyComponent = () => {
  const { addFile, updateFileProgress, updateFileStatus } = useFileContext();

  const handleUpload = async (file: File) => {
    addFile(file);
    // Manual state management...
  };

  return <FileUploader onUpload={handleUpload} />;
};

// Requires provider wrapper
<FileContextProvider>
  <MyComponent />
</FileContextProvider>
```

**After (Standalone Mode):**

```jsx
import { FileUploader, FileWithStatus, UploadResult } from 'sds-ui';

const MyComponent = () => {
  const [files, setFiles] = useState<FileWithStatus[]>([]);

  const handleUpload = async (file: File): Promise<UploadResult> => {
    // Return result, automatic state management
    return { success: true, file };
  };

  return (
    <FileUploader
      files={files}
      onFilesChange={setFiles}
      onUpload={handleUpload}
    />
  );
};

// No provider needed!
```

### Key Benefits of Migration

1. **Simpler Setup** - No context provider wrapper required
2. **Better Performance** - Eliminates unnecessary context re-renders
3. **Clearer Data Flow** - Explicit props instead of implicit context
4. **Enhanced Type Safety** - Better TypeScript support with Promise-based uploads
5. **API Flexibility** - Built-in adapters for common upload patterns

### Breaking Changes in v2.0

- Context-based usage will be removed
- `onUpload` must return `Promise<UploadResult>` (not void)
- `standalone` prop will default to `true`

## Notes for Developers

- These components are complex and have many features. Test thoroughly in your application.
- Use built-in upload adapters for common patterns (REST, FormData, S3)
- The `renderFileCard` function allows complete customization of file display
- Adjust validation props (`maxFileSize`, `maxFiles`, `accept`) according to your requirements
- Consider using controlled mode (`files` + `onFilesChange`) for complex file management scenarios

For questions or issues, please reach out to **nickpino.designs@gmail.com** or create a Jira ticket assigned to **nicholas.pino**.
